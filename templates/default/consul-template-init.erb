#!/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin
NAME="consul-template"

USER=root
DAEMON="<%= @command %>"

LOGFILE="/var/log/$NAME.log"

SCRIPTNAME=/etc/init.d/${NAME}
PIDFILE="/var/run/$NAME.pid"
LOCKFILE="/var/run/lock/${NAME}"
SHUTDOWN_TIMEOUT=1

[ -f /etc/default/${NAME} ] && . /etc/default/${NAME}

DEAMON_OPTS="<%= @options %>"

export GOMAXPROCS=${GOMAXPROCS}

. /lib/lsb/init-functions

start() {
        echo "Starting $NAME: "
        daemonize -u $USER -p $PIDFILE -l $LOCKFILE -o $LOGFILE -e $LOGFILE -E GOMAXPROCS=${GOMAXPROCS} $DAEMON $DEAMON_OPTS
        log_end_msg $?
}

stop(){
        [ -e "$PIDFILE" ] && [ ! -z "$(cat $PIDFILE)" ] && test -d "/proc/$(cat $PIDFILE)" && kill -SIGTERM $(cat $PIDFILE)
        log_daemon_msg "Stopping $NAME: "
        flock --exclusive --timeout $SHUTDOWN_TIMEOUT $LOCKFILE --command "echo -n"
        if [ $? -ne 0 ]; then
                kill -SIGKILL $(cat $PIDFILE)
                flock --exclusive --timeout 1 $LOCKFILE --command "echo -n"
        fi
        log_end_msg $?
}
reload(){
        [ -e "$PIDFILE" ] && [ ! -z "$(cat $PIDFILE)" ] && test -d "/proc/$(cat $PIDFILE)" && kill -SIGHUP $(cat $PIDFILE)
        sleep 1
        log_daemon_msg "reloading $NAME: "
        log_end_msg $?
}
status(){
    [ -e "$PIDFILE" ] && [ ! -z "$(cat $PIDFILE)" ] && test -d "/proc/$(cat $PIDFILE)" && echo "$NAME is running"
    if [ $? -ne 0 ]; then
        echo "$NAME is stopped"
        exit 1
    fi
}

case "$1" in
        start)
                start
                ;;
        stop)
                stop
                ;;
        reload)
                reload
                ;;
        status)
                status
                ;;
        restart)
                stop
                sleep 0.1
                start
                ;;
        *)
                echo "Usage: $SCRIPTNAME {start|stop|restart|reload}" >&2
                exit 1
                ;;
esac

exit 0